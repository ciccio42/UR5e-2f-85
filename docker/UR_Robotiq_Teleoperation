# Docker for UR robots with Robotiq grippers and PS4 controller support on ROS 2 Jazzy
FROM ur_robotiq

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_DISTRO=jazzy
ENV ROS_WS=/home/ros2_ws

# Install system dependencies for PS4 controller support
RUN apt-get update && apt-get install -y \
    joystick \
    jstest-gtk \
    evtest \
    udev \
    libudev-dev \
    libhidapi-dev \
    python3-pip \
    ros-${ROS_DISTRO}-joy \
    && rm -rf /var/lib/apt/lists/*

# Optional: install ds4drv (mostly useful for Bluetooth, harmless for USB)
RUN pip3 install --no-cache-dir --break-system-packages ds4drv

# Ensure udev rules directory exists
RUN mkdir -p /etc/udev/rules.d

# Optional udev rule for PS4 controller (USB access without root)
RUN echo 'KERNEL=="js*", MODE="0666"' > /etc/udev/rules.d/99-joystick.rules && \
    echo 'KERNEL=="event*", MODE="0666"' >> /etc/udev/rules.d/99-joystick.rules

RUN apt update && apt install -y iputils-ping \
&& source /opt/ros/${ROS_DISTRO}/setup.bash \
&& colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release

# Source ROS 2 automatically
# Add entrypoint
COPY ./ur_robotiq_teleoperation_entrypoint.sh /ur_robotiq_teleoperation_entrypoint.sh
ENTRYPOINT ["/ur_robotiq_teleoperation_entrypoint.sh"]

WORKDIR ${ROS_WS}
CMD ["bash"]
